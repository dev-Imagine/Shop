@{
    @model Shop.Models.Categoria

}


<div class="modal fade" id="popupCategoria" tabindex="-1" role="dialog" aria-labelledby="popupCategoria" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="div-frmProveedor">
                <form class="" style="display: flex; flex-wrap: wrap;" autocomplete="off">
                        <span id="spnTituloPopUp" class="">
                            Nueva categoría
                        </span>
                    <div>
                        <input id="popup_idCategoria" value="@Model.idCategoria" class="dis-none">
                    </div>
                    <div class="" style="width: 100%;" >
                        <input class="form-control" id="popup_NombreCategoria" type="text" placeholder="Nombre" value="">
                    </div>
                    <div class="" style="width: 80%;">
                        <input class="form-control" id="popup_Subcategoria" type="text" placeholder="Subcategorías">
                    </div>

                    <div class="" style="width: 20%;">
                        <button type="button" class="btn btn-outline-dark" style="width: 100%; height: 57px; border-radius: inherit;" onclick="AgregarSubcategoria()"><i class="fa fa-plus"></i></button>
                    </div>

                    <div id="popup_div-Subcategorias" style="width:100%;">
                        @{
                            foreach (Shop.Models.SubCategoria oSubcategoria in Model.SubCategoria.ToList())
                            {
                                <div-subC id="div-Subcategoria-@oSubcategoria.idSubCategoria" data-id="@oSubcategoria.idSubCategoria" data-content="@oSubcategoria.nombre" style="width:100%;">
                                    <div class="item-seleccionado" style="border-color:#000;">
                                        <span style="float:right">
                                            <a style="cursor:pointer" onclick="EliminarSubcategoria('@oSubcategoria.idSubCategoria')">
                                                <i class="" aria-hidden="true"></i>
                                            </a>
                                        </span>
                                        <p style="margin-bottom: 0px;">@oSubcategoria.nombre</p>
                                    </div>
                                </div-subC>
                            }
                        }

                    </div>


                    <button type="button" class="btn btn-success" style="width:100%" onclick="GuardarCategoria()">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function GuardarCategoria() {
        var IdCategoria = $('#popup_idCategoria').val();
        $('#popup_idCategoria').val('');
        var NombreCategoria = $('#popup_NombreCategoria').val();
        $('#popup_NombreCategoria').val('');
        if (NombreCategoria.trim() == '') {
            return;
        }
        var Subcategorias = [];
        $("#popup_div-Subcategorias div-subC").each(function () {
            var subcategoria = $(this).attr("data-id") + ";" + $(this).attr("data-content");
            Subcategorias.push(subcategoria);
        });

        var url = "@Url.Action("GuardarModificarCategoria", "Product")";
        var data = { 'oCategoria.idCategoria': IdCategoria, 'oCategoria.nombre': NombreCategoria, Subcategorias: Subcategorias };

        $.post(url, data).done(function (data) {
            if (data.length != 0) {
                var datos = data.split(';');
                $('#select-Categorias').append($('<option>', {
                    value: datos[0],
                    text: datos[1]
                }));
                $("#select-Categorias").val(datos[0]);
                $("#select-Categorias").change();
                swal("Exito!", "La categoría y sus subcategorías ha sido creada/actualizada.", "success");
            }
            else {
                swal("Ocurrió un error", "Se produjo un error al intentar guardar/actualizar la categoría y sus subcategorías.", "error");
            }
            $('#popup_NombreCategoria').modal('hide');
            $("#popup_Subcategoría").val("");
            $("#Subcategorias").innerHTML = '';

        });
        $('#popupCategoria').hide();
    }
    var contador = 0;
    function AgregarSubcategoria()
    {
        contador++;
        var NombreSubcategoria = $('#popup_Subcategoria').val();
        if (NombreSubcategoria.trim ="") {
            return;
        }
        $('#popup_Subcategoria').val('');
        $("#popup_div-Subcategorias").append("<div-subC id=\"div-Subcategoria-000000000000000" + contador + "\" data-id=\"0\" data-\content=\"" + NombreSubcategoria + "\" style=\"width:100%;\"><div class=\"item-seleccionado\" style=\"border-color:#000;\"><span style=\"float:right\"><a style=\"cursor:pointer\" onclick=\"EliminarSubcategoria('000000000000000" + contador + "')\"><i class=\"far fa-times-circle\" aria-hidden=\"true\"></i></a></span><p style=\"margin-bottom: 0px;\">" + NombreSubcategoria + "</p></div></div-subC >");
    }

    function EliminarSubcategoria(id_Subcategoria) {
        if (id_Subcategoria.includes("000000000000000")) {
            $('#div-Subcategoria-' + id_Subcategoria).remove();
        } else
        {
            var url = "@Url.Action("EliminarSubCategoria", "Product")";
            var data = { id_Subcategoria: id_Subcategoria };

            $.post(url, data).done(function (data) {
                if (data == "True") {
                    $('#div-Subcategoria-' + id_Subcategoria).remove();
                }
                else {
                    swal("Ocurrió un error", data, "error");
                }
            });
        }
    }
</script>
